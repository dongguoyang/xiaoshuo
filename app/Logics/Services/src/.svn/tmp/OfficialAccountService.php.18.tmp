<?php

namespace App\Logics\Services\src;

use App\Logics\Repositories\src\CommonSetRepository;
use App\Logics\Repositories\src\DomainRepository;
use App\Logics\Repositories\src\NovelRepository;
use App\Logics\Repositories\src\StorageImgRepository;
use App\Logics\Repositories\src\TestRepository;
use App\Logics\Repositories\src\UserRepository;
use App\Logics\Repositories\src\WechatConfigRepository;
use App\Logics\Repositories\src\WechatMsgReplyRepository;
use App\Logics\Repositories\src\WechatQrcodeRepository;
use App\Logics\Repositories\src\WechatRepository;
use App\Logics\Services\Service;
use App\Logics\Traits\OfficialAccountTrait;
use App\Logics\Traits\PushmsgTrait;
use EasyWeChat\Factory;
use EasyWeChat\Kernel\Encryptor;
use EasyWeChat\Kernel\Messages\News;
use EasyWeChat\Kernel\Messages\NewsItem;

class OfficialAccountService extends Service {
    use PushmsgTrait, OfficialAccountTrait;
	protected $officialAccount; // easy wechat çš„ officialAccount å¯¹è±¡
	protected $Encryptor;

	protected $token = 'zmr2token';
	protected $aes_key = 'nafVTCVpgK1NDz96UyL4HZpRsyzoe6TBgdQLByhg88b';

    protected $wechats;
    protected $tests;
    protected $wechatMsgReplies;
    protected $wechatConfigs;
    protected $novels;
    protected $users;
    protected $domains;
    protected $wechatQrcodes;
    protected $commonSets;
    protected $storageImgs;

	public function Repositories() {
		return [
			'wechats'           => WechatRepository::class,
			'tests'             => TestRepository::class,
            'wechatMsgReplies'  => WechatMsgReplyRepository::class,
            'wechatConfigs'     => WechatConfigRepository::class,
            'novels'            => NovelRepository::class,
            'users'             => UserRepository::class,
            'domains'           => DomainRepository::class,
            'wechatQrcodes'     => WechatQrcodeRepository::class,
            'commonSets'        => CommonSetRepository::class,
            'storageImgs'       => StorageImgRepository::class,
		];
	}
    /**
     * è·å–å¼€æ”¾å¹³å°ä¿¡æ¯
     */
    private function setOfficialAccount($appid = '') {
        $appid = $appid ?: request()->input('appid');
        $wechat = $this->wechats->findBy('appid', $appid, $this->wechats->model->fields);

        if (!$wechat['token'] || $wechat['token_out'] < time()) {
            $wechat = $this->updateWechatAccessToken($wechat);
        }

        $config = [
            'app_id' => $wechat['appid'],
            'secret' => $wechat['appsecret'],

            'token'         => $wechat['service_token'],
            'aes_key'       => $wechat['service_aes_key'],// EncodingAESKeyï¼Œå…¼å®¹ä¸å®‰å…¨æ¨¡å¼ä¸‹è¯·ä¸€å®šè¦å¡«å†™ï¼ï¼ï¼

            'response_type' => 'array',
        ];

        $this->officialAccount = Factory::officialAccount($config);
    }

	/**
	 * å…¬ä¼—å·æ¶ˆæ¯ä¸äº‹ä»¶æ¥æ”¶
	 * @param Request $request
	 * @return \Illuminate\Http\JsonResponse|mixed|\Symfony\Component\HttpFoundation\Response
	 */
	public function wechatEvent($request) {
	    if (isset($request->echostr)) {
            // æœåŠ¡å™¨é…ç½®éªŒè¯
	        if ($this->checkSignature()) {
	            exit($request->echostr);
            }
        }

	    // æ­£å¸¸çš„ä¸šåŠ¡é€»è¾‘
		$xml = file_get_contents('php://input');
		$input = request()->all();
		$this->tests->create(['type' => 'wechatEvent.xml', 'content' => $xml]);
		$this->tests->create(['type' => 'wechatEvent.input', 'content' => http_build_query($input)]);

		$this->setOfficialAccount($input['appid']);

		/**
		 * ç®€å•çš„å¤„ç† æ–‡æœ¬æ¶ˆæ¯å’Œäº‹ä»¶
		 */
        $this->officialAccount->server->push(function ($message) {
            switch ($message['MsgType']) {
                case 'event':
                    // return 'æ”¶åˆ°äº‹ä»¶æ¶ˆæ¯';// å¤„ç†äº‹ä»¶æ¶ˆæ¯
                    return $this->operateEvent($message);
                    break;
                case 'text':
                    // return 'æ”¶åˆ°æ–‡å­—æ¶ˆæ¯';// å¤„ç†æ–‡æœ¬æ¶ˆæ¯
                    return $this->operateText($message);
                    break;
                case 'image':
                    // return 'æ”¶åˆ°å›¾ç‰‡æ¶ˆæ¯';// å¤„ç†å›¾ç‰‡æ¶ˆæ¯
                    return $this->operateImage($message);
                    break;
                case 'voice':
                    // return 'æ”¶åˆ°è¯­éŸ³æ¶ˆæ¯';å¤„ç†è¯­éŸ³æ¶ˆæ¯
                    return $this->operateDefault($message);
                    break;
                case 'video':
                    // return 'æ”¶åˆ°è§†é¢‘æ¶ˆæ¯';
                    return $this->operateDefault($message);
                    break;
                case 'location':
                    // return 'æ”¶åˆ°åæ ‡æ¶ˆæ¯';
                    return $this->operateDefault($message);
                    break;
                case 'link':
                    // return 'æ”¶åˆ°é“¾æ¥æ¶ˆæ¯';
                    return $this->operateDefault($message);
                    break;
                case 'file':
                    // return 'æ”¶åˆ°æ–‡ä»¶æ¶ˆæ¯';
                    return $this->operateDefault($message);
                // ... å…¶å®ƒæ¶ˆæ¯
                default:
                    // æ¥æ”¶ æœåŠ¡å™¨éªŒè¯
                    break;
            }
        });
		// $server->push(TextMessageHandler::class, Message::TEXT);
		// $server->push(EventMessageHandler::class, Message::EVENT);

		$response = $this->officialAccount->server->serve();
		return $response;
	}
    /**
     * äº‹ä»¶æ¶ˆæ¯å¤„ç†å™¨
     * @param array $message
     */
    private function operateEvent($message) {
        // äº‹ä»¶æ¶ˆæ¯å¤„ç†å™¨
        // ä¿®æ”¹ç”¨æˆ·çš„å…³æ³¨ä¸å¦çŠ¶æ€
        $appid = request()->input('appid');

        // è®°å½•æœ€è¿‘æœ‰äº’åŠ¨çš„ç”¨æˆ·
        $wechat = $this->wechats->getWechatForAppid($appid); // è·å–å…¬ä¼—å·ä¿¡æ¯

        // åªå¤„ç†å…³æ³¨äº‹ä»¶
        switch ($message['Event']) {
            case 'unsubscribe':
                // å–æ¶ˆå…³æ³¨äº‹ä»¶
                $this->addOrDelUserTag($wechat, $message['FromUserName'], $message['Event']);// åˆ é™¤ç”¨æˆ·æ ‡ç­¾
                $this->users->SubscribeEvent($wechat['id'], $message['FromUserName'], $message['Event']);// ä¿®æ”¹ç”¨æˆ·çš„å…³æ³¨ä¸å¦çŠ¶æ€
                return 'å–æ¶ˆå…³æ³¨æˆåŠŸï¼';
                break;
            case 'subscribe':
                // å…³æ³¨äº‹ä»¶
                $this->addOrDelUserTag($wechat, $message['FromUserName'], $message['Event']); // æ·»åŠ ç”¨æˆ·æ ‡ç­¾
                try {
                    $this->users->SubscribeEvent($wechat['id'], $message['FromUserName'], $message['Event']);// ä¿®æ”¹ç”¨æˆ·çš„å…³æ³¨ä¸å¦çŠ¶æ€
                }catch (\Exception $e) { }

                if (isset($message['EventKey'])) {
                    // æ‰«æçš„å¸¦å‚æ•°äºŒç»´ç 
                    $scene = substr($message['EventKey'], 8);
                    if ($scene) {
                        // å¸¦å‚æ•°äºŒç»´ç å…³æ³¨
                        $scene = Array2String($scene);
                        $novel_id   = isset($scene['n']) ? $scene['n'] : 0;
                        $section    = isset($scene['s']) ? $scene['s'] : 0;
                        if (isset($scene['id']) && $scene['id']) {
                            $this->wechatQrcodes->IncColumns($scene['id'], ['scan_num'=>1, 'sub_num'=>1]);
                            // ç›´æ¥çš„å¸¦å‚äºŒç»´ç 
                            $rel = $this->paramsQrcode($wechat, $message, $scene);
                        } else if ($novel_id && $section) {
                            $rel = $this->qrcodeSend($wechat, $message, $novel_id, $section);
                        } else {
                            if (isset($scene['sc']) && $scene['sc']=='searchsub') {
                                $rel = $this->qrcodeSend($wechat, $message, $scene['sc']);
                            } else {
                                $rel = $this->qrcodeSend($wechat, $message);
                            }
                        }
                    } else {
                        // ä¸€èˆ¬çš„æœç´¢å…³æ³¨
                        $rel = $this->qrcodeSend($wechat, $message, 'searchsub');
                    }
                } else {
                    // ä¸€èˆ¬çš„æœç´¢å…³æ³¨
                    $rel = $this->qrcodeSend($wechat, $message, 'searchsub');
                }
                break;
            case 'SCAN':
                // å¸¦å‚æ•°äºŒç»´ç æ‰«ç äº‹ä»¶
                if (isset($message['EventKey'])) {
                    // æ‰«æçš„å¸¦å‚æ•°äºŒç»´ç 
                    $scene = $message['EventKey']; // æ‰«ç äº‹ä»¶æ²¡æœ‰å‰é¢çš„8ä¸ªå­—ç¬¦ï¼›ä¸ç”¨æˆªå–å­—ç¬¦ä¸²
                    if ($scene) {
                        // å¸¦å‚æ•°äºŒç»´ç å…³æ³¨
                        $scene = Array2String($scene);
                        if (isset($scene['id']) && $scene['id']) {
                            $this->wechatQrcodes->IncColumns($scene['id'], ['scan_num'=>1]);
                            // ç›´æ¥çš„å¸¦å‚äºŒç»´ç 
                            $rel = $this->paramsQrcode($wechat, $message, $scene);
                            break;
                        }
                    }
                }
                $rel = $this->qrcodeSend($wechat, $message);
                break;
            /*case 'CLICK':// ç‚¹å‡»èœå•æ‹‰å–æ¶ˆæ¯æ—¶çš„äº‹ä»¶æ¨é€
            case 'VIEW':// ç‚¹å‡»èœå•è·³è½¬é“¾æ¥æ—¶çš„äº‹ä»¶æ¨é€
                // è®°å½•æœ€è¿‘æœ‰äº’åŠ¨çš„ç”¨æˆ·
                $this->users->NoteInteractInfo($plat_wechat, $message['FromUserName']);// æ‰§è¡Œè®°å½•
                break;*/
            default:
                $rel = null;
                break;
        }
        $this->users->NoteInteractInfo($wechat, $message['FromUserName']);// æ‰§è¡Œäº’åŠ¨è®°å½•
        return $rel;
    }
    // è‡ªå®šä¹‰å‚æ•°ç”Ÿæˆçš„å¸¦å‚äºŒç»´ç 
    private function paramsQrcode($plat_wechat, $message, $scene) {
        $host = $this->domains->randOne(1, $plat_wechat['customer_id']); // è·å–å†…æ¨å…¥å£åŸŸå
        $novel = ['title' => 'å¥³å©¿çš„äººç”Ÿ', 'id'=>186807, 'section'=>3, 'img'=>'https://ccccccc1111111.oss-cn-hangzhou.aliyuncs.com/novel/poster/202001/b19f62a41b844914780350059f112abc.png'];
        if (isset($scene['n'])) {
            $novel = $this->novels->NovelInfo($scene['n']);
            $novel['section'] = isset($scene['s']) ? $scene['s'] : 3;
        }
        $con_url = $host . route("jumpto", ['route'=>'section', 'novel_id'=>$novel['id'], 'section_num'=>$novel['section'], 'section'=>$novel['section'], 'customer_id'=>$plat_wechat['customer_id'], 'otherdo'=>'secondpush', 'dtype'=>2, 'uid'=>-1, 'tologin'=>1, 'wq'=>$scene['id']], false);

        $sub_reply_imgfont = $this->commonSets->values('subscribe', 'reply_imgfont');
        if ($sub_reply_imgfont == 1 || strpos($sub_reply_imgfont, ','.$plat_wechat['customer_id'].',')!==false) {
            // å›å¤å›¾æ–‡æ¶ˆæ¯
            $img = $novel['img'];
            $storageImgList   = $this->storageImgs->ImgList();
            if ($storageImgList) {
                $info = $storageImgList[array_rand($storageImgList)];
                if ($info) {
                    $img = $info['img'];
                }
            }
            $item = [
                new NewsItem([
                    'title'         => "æ¬¢è¿ï¼æ‚¨ä¸Šæ¬¡é˜…è¯»çš„å°è¯´åœ¨ã€Š{$novel['title']}ã€‹",
                    'description'   => "ğŸ‘‰ğŸ‘‰ ç‚¹å‡»ç»§ç»­é˜…è¯»ç« èŠ‚",
                    'url'           => $con_url,
                    'image'         => $img,
                ]),
            ];
            return new News($item);
        } else {
            $str = "æ¬¢è¿ï¼æ‚¨ä¸Šæ¬¡é˜…è¯»çš„å°è¯´åœ¨ã€Š{$novel['title']}ã€‹ï¼š\r\n\r\n";
            $str .= "ğŸ‘‰ <a href='{$con_url}'>ç‚¹å‡»ç»§ç»­é˜…è¯»ç« èŠ‚</a>\r\n\r\n";
            $str .= "ğŸ‘‡ ä¸ºæ‚¨æ¨è\r\n\r\n";
            $novels = $this->novels->model->where('status', 2)->orderBy('week_read_num', 'desc')->limit(4)->select(['id', 'title', 'img'])->get();
            foreach ($novels as $novel) {
                $url = $host . route("jumpto", ['route'=>'novel', 'novel_id'=>$novel['id'], 'customer_id'=>$plat_wechat['customer_id'], 'dtype'=>2, 'uid'=>-1, 'wq'=>$scene['id']], false);
                $str .= "ğŸ“– <a href='{$url}'>ã€Š{$novel['title']}ã€‹</a> ğŸ‘ˆ \r\n\r\n";
            }

            if ($plat_wechat['appid'] == 'wx12c2fc011f97322e') {
                $str .= "éœ€è¦å¸®åŠ©ï¼æ·»åŠ  ğŸ‘‰ï¼Œ<a href='https://mp.weixin.qq.com/s/N1X9WpgP3vwKMrp8-Tctlg'>å°å¦¹å¾®ä¿¡ï¼ˆå®¢æœï¼‰</a>";
            } else {
                //$str .= "ä¸ºæ–¹ä¾¿ä¸‹æ¬¡é˜…è¯»ï¼Œè¯· <a href='{$host}/img/wechat.totop.png'>ç½®é¡¶ å…¬ä¼—å·</a>";
                $str .= $this->strEndKefuLink($host, $plat_wechat['customer_id']);
            }

            return $str;
        }
    }
    // æ·»åŠ æˆ–è€…åˆ é™¤ç”¨æˆ·æ ‡ç­¾
    private function addOrDelUserTag($plat_wechat, $openid, $type) {
        $wechat_config = $this->wechatConfigs->FindByCustomer2PlatWechat($plat_wechat['customer_id'], $plat_wechat['id']); // è·å–å…¬ä¼—å·é…ç½®
        if (!$wechat_config['user_tags']) return false;
        $tags = json_decode($wechat_config['user_tags'], 1);
        // {"tag":{"id":102,"name":"å·²å…³æ³¨"}}
        if (!isset($tags['tag']['id']) || !$tags['tag']['id']) return false;
        $tag_id = $tags['tag']['id'];
        /*{
            "openid_list" : [//ç²‰ä¸åˆ—è¡¨
                "ocYxcuAEy30bX0NXmGn4ypqx3tI0",
                "ocYxcuBt0mRugKZ7tGAHPnUaOW7Y"
            ],
            "tagid" : 134
         }*/
        $data = [
            'openid_list' => [
                $openid,
            ],
            'tagid' => $tag_id,
        ];
        try {
            if ($type == 'subscribe') {
                $this->UserTagManage($plat_wechat['customer_id'], 'batch-tag', $data);
            } else {
                $this->UserTagManage($plat_wechat['customer_id'], 'batch-un-tag', $data);
            }
        } catch (\Exception $e) {
            return $e->getMessage();
        }
    }
    /**
     * äºŒç»´ç å…³æ³¨äº‹ä»¶å›å¤
     * @param array $plat_wechat
     * @param array $message
     * @param int $novel_id
     * @param int $section_id
     */
    private function qrcodeSend($plat_wechat, $message, $novel_id=0, $section=0) {
        // if (!$novel_id) { return null; }

        $wechat_config = $this->wechatConfigs->FindByCustomer2PlatWechat($plat_wechat['customer_id'], $plat_wechat['id']); // è·å–å…¬ä¼—å·é…ç½®
        $host = $this->domains->randOne(1, $wechat_config['customer_id']); // è·å–å†…æ¨å…¥å£åŸŸå
        /*// æ¨é€æŒ‡å®šçš„ç« èŠ‚ä¿¡æ¯
        $url = $host . route("jumpto", ['route'=>'section', 'section_num'=>$section, 'novel_id'=>$novel_id, 'section'=>$section, 'customer_id'=>$plat_wechat['customer_id'], 'otherdo'=>'secondpush', 'dtype'=>2], false);
        if (!$novel_id) {
            //$url = $host . route('novel.toindex', ['cid'=>$plat_wechat['customer_id'], 'dtype'=>5], false);
            $url = $host . route('jumpto', ['route'=>'index', 'cid'=>$plat_wechat['customer_id'], 'dtype'=>2], false);
        }*/
        $user = $this->users->FindByOpenid($message['FromUserName'], ['name', 'id', 'first_account']);
        if ($novel_id == 'searchsub' &&
            isset($wechat_config['search_sub']['switch']) &&
            intval($wechat_config['search_sub']['switch'])==1) {
            // ç›´æ¥æœç´¢å…¬ä¼—å·è¿›è¡Œæ“ä½œçš„å…³æ³¨
            $uid = $user ? ($user['first_account'] > 0 ? $user['first_account'] : $user['id']) : -1;
            // return $this->noUserSearchSubPush($host, $plat_wechat, $wechat_config['search_sub'], $uid);
            return $this->searchSubPushMsg($host, $plat_wechat, $wechat_config['search_sub'], $uid);
        }

        if (!$user) {
            if (isset($wechat_config['search_sub']['switch']) && intval($wechat_config['search_sub']['switch'])==1) {
                return $this->noUserSearchSubPush($host, $plat_wechat, $wechat_config['search_sub']);
            } else {
                return $this->noUserPush($host, $plat_wechat, 5);
            }
        } else {
            // è¿™æ ·æ˜¯æ–¹ä¾¿è·å–æœ€è¿‘é˜…è¯»è®°å½•
            $r_params = ['route'=>'section', 'section_num'=>$section, 'novel_id'=>$novel_id, 'section'=>$section, 'customer_id'=>$plat_wechat['customer_id'], 'otherdo'=>'secondpush', 'dtype'=>2, 'uid'=>$user['id'], 'tologin'=>1];
            if ($novel_id > 0) {
                $r_params['nsa1'] = 1; // å¤–æ¨è¿›å…¥éœ€å¢åŠ ä¸€ç« é˜…è¯»
            }
            $url = $host . route("jumpto", $r_params, false);
        }
        switch ($wechat_config['subscribe_msg']) {
            case 1:
                /*if (!$novel_id) {
                    return $this->noUserPush($host, $plat_wechat, 5); // ç›´æ¥å…³æ³¨å»å¤–æ¨åŸŸå
                }*/
                $title = '';
                if ($novel_id) {
                    $novel = $this->novels->NovelInfo($novel_id);
                    if (isset($novel['title'])) $title = "ã€Š{$novel['title']}ã€‹";
                }
                $str = "ä½ å¥½ï¼Œæ¬¢è¿å…³æ³¨ <a href='{$url}'>{$plat_wechat['name']}</a>ï¼ \r\n\r\n <a href='{$url}'>è¯·ç‚¹å‡»æˆ‘ç»§ç»­é˜…è¯»{$title}</a>";
                return $str;
            case 2:
                $user = $this->users->findBy('openid', $message['FromUserName'], ['name']);
                $str = "äº²çˆ±çš„{$user['name']}ï¼Œæ¬¢è¿å…³æ³¨ <a href='{$url}'>{$plat_wechat['name']}</a>ï¼ \r\n\r\n <a href='{$url}'> è¯·ç‚¹å‡»æˆ‘ç»§ç»­é˜…è¯»åˆšæ‰çš„å°è¯´å§ï¼</a>";
                return $str;
            case 3:
                $user = $this->users->findBy('openid', $message['FromUserName'], ['name']);
                $str = "äº²çˆ±çš„{$user['name']}ï¼Œæ¬¢è¿æ‚¨~ <a href='{$url}'>ç‚¹å‡»æˆ‘ç»§ç»­é˜…è¯»åˆšæ‰çš„å°è¯´å§ï¼</a>";
                return $str;
            case 4:
                // å›¾æ–‡æ¶ˆæ¯å›å¤
                $subscribe_content = json_decode($wechat_config['subscribe_content'], 1);
                if ($subscribe_content) {
                    $novel['title'] = $subscribe_content['title'];
                    $novel['desc']  = $subscribe_content['desc'];
                    $novel['img']   = $subscribe_content['img'];
                } elseif ($novel_id) {
                    $novel = $this->novels->NovelInfo($novel_id);
                } else {
                    $novel['title'] = $plat_wechat['name'];
                    $novel['desc']  = 'æ¬¢è¿æ‚¨çš„åˆ°æ¥ï¼Œå…³æ³¨æˆ‘å¯ä»¥é˜²æ­¢è¿·è·¯å“¦ï¼Œåç»­è§‚çœ‹æ›´æ–¹ä¾¿ï¼';
                    $novel['img']   = 'http://dev.zmr029.com/img/zmr.logo.png';
                }
                $item = [
                    new NewsItem([
                        'title'         => $novel['title'],
                        'description'   => $novel['desc'],
                        'url'           => $url,
                        'image'         => $novel['img'],
                    ]),
                ];
                return new News($item);
            // case 5:
            default:
                $str = "<a href='{$url}'>~ç‚¹å‡»ç»§ç»­é˜…è¯»ï¼</a>";
                return $str;
        }
    }
    /**
     * æ²¡æœ‰è®¾ç½®å…³é”®å­—çš„é»˜è®¤å›å¤
     * @param string $host
     * @param array $plat_wechat å…¬ä¼—å·ä¿¡æ¯
     * @param int $dtype åŸŸåç±»å‹
     */
    private function noUserPush($host, $plat_wechat, $dtype=2, $uid = -1) {
        $novels = $this->novels->model->where('status', 2)->orderBy('week_read_num', 'desc')->limit(4)->select(['id', 'title', 'img'])->get();
        $str = "æ¬¢è¿ï¼æ‚¨.ä¸Šæ¬¡é˜…è¯»çš„å°è¯´åœ¨ã€Šå¥³å©¿çš„äººç”Ÿã€‹ï¼š\r\n\r\n";
        $url = $host . route("jumpto", ['route'=>'section', 'novel_id'=>186807, 'section_num'=>3, 'section'=>3, 'customer_id'=>$plat_wechat['customer_id'], 'dtype'=>2, 'uid'=>$uid], false);
        $str .= "ğŸ‘‰ <a href='{$url}'>ç‚¹å‡»ç»§ç»­é˜…è¯»ç« èŠ‚</a>\r\n\r\n";
        $str .= "ğŸ‘‡ ä¸ºæ‚¨æ¨è\r\n\r\n";
        foreach ($novels as $novel) {
            $url = $host . route("jumpto", ['route'=>'novel', 'novel_id'=>$novel['id'], 'customer_id'=>$plat_wechat['customer_id'], 'dtype'=>2, 'uid'=>$uid], false);
            $str .= "ğŸ“– <a href='{$url}'>ã€Š{$novel['title']}ã€‹</a> ğŸ‘ˆ \r\n\r\n";
        }
        //$str .= "ä¸ºæ–¹ä¾¿ä¸‹æ¬¡é˜…è¯»ï¼Œè¯· <a href='{$host}/img/wechat.totop.png'>ç½®é¡¶ å…¬ä¼—å·</a>";
        $str .= $this->strEndKefuLink($host, $plat_wechat['customer_id']);
        /*$novels = $this->novels->model->where('status', '>', 0)->orderBy('week_read_num', 'desc')->limit(5)->select(['id', 'title', 'img'])->get();
        $str = "æ‚¨å¥½ï¼Œ{$plat_wechat['name']}ä¸ºæ‚¨æ¨èï¼š\r\n\r\n";
        foreach ($novels as $novel) {
            $url = $host . route("jumpto", ['route'=>'novel', 'novel_id'=>$novel['id'], 'customer_id'=>$plat_wechat['customer_id'], 'dtype'=>$dtype, 'uid'=>$uid], false);
            $str .= "ğŸ‘‰<a href='{$url}'>{$novel['title']}</a> \r\n\r\n";
        }
        $str .= 'ç‚¹å‡»ä¸Šæ–¹è“è‰²å­—é˜…è¯» '. implode('', $this->emojiArr(3));*/
        return $str;
    }
    /**
     * æ²¡æœ‰ç”¨æˆ·ï¼›ç›´æ¥æœç´¢çš„å…³æ³¨
     * @param string $host
     * @param array $plat_wechat å…¬ä¼—å·ä¿¡æ¯
     * @param int $dtype åŸŸåç±»å‹
     */
    private function searchSubPushMsg($host, $plat_wechat, $conf, $uid = -1) {
        $i = 0;
        $str = "æ¬¢è¿ï¼æ„Ÿè°¢æ‚¨å…³æ³¨ã€Š{$plat_wechat['name']}ã€‹\r\n\r\n";
        //$url = $host . route("jumpto", ['route'=>'novel', 'novel_id'=>$conf['nid'][$i], 'customer_id'=>$conf['snum'][$i], 'dtype'=>2, 'uid'=>$user_id], false);
        $url = $host . route("jumpto", ['route'=>'section', 'novel_id'=>$conf['nid'][$i], 'section_num'=>$conf['snum'][$i], 'section'=>$conf['snum'][$i], 'customer_id'=>$plat_wechat['customer_id'], 'dtype'=>2, /*'uid'=>$uid,*/ 'tologin'=>1], false);
        $str .= "ğŸ‘‰ <a href='{$url}'>{$conf['title'][$i]}</a>\r\n\r\n";
        //$str .= "ğŸ‘‡ ä¸ºæ‚¨æ¨è\r\n\r\n";
        $i++;
        while ($i<count($conf['nid'])) {
            $url = $host . route("jumpto", ['route'=>'section', 'novel_id'=>$conf['nid'][$i], 'section_num'=>$conf['snum'][$i], 'section'=>$conf['snum'][$i], 'customer_id'=>$plat_wechat['customer_id'], 'dtype'=>2, /*'uid'=>$uid,*/ 'tologin'=>1], false);
            $str .= "ğŸ‘‰ <a href='{$url}'>{$conf['title'][$i]}</a> \r\n\r\n";
            $i++;
        }
        $str .= "ä¸ºæ–¹ä¾¿ä¸‹æ¬¡é˜…è¯»ï¼Œè¯· <a href='{$host}/img/wechat.totop.png'>ç½®é¡¶ å…¬ä¼—å·</a>";
        return $str;
    }
    /**
     * æ²¡æœ‰ç”¨æˆ·ï¼›ç›´æ¥æœç´¢çš„å…³æ³¨
     * @param string $host
     * @param array $plat_wechat å…¬ä¼—å·ä¿¡æ¯
     * @param int $dtype åŸŸåç±»å‹
     */
    private function noUserSearchSubPush($host, $plat_wechat, $conf, $uid = -1) {
        $novels = $this->novels->model->where('status', 2)->orderBy('week_read_num', 'desc')->limit(4)->select(['id', 'title', 'img'])->get();
        $str = "æ¬¢è¿ï¼æ‚¨ä¸Šæ¬¡é˜…è¯»çš„å°è¯´æ˜¯ï¼š{$conf['title']}\r\n\r\n";
        $str .= "ğŸ‘‰ <a href='{$conf['link']}'>ç‚¹å‡»ç»§ç»­é˜…è¯»ç« èŠ‚</a>\r\n\r\n";
        $str .= "ğŸ‘‡ ä¸ºæ‚¨æ¨è\r\n\r\n";
        foreach ($novels as $novel) {
            $url = $host . route("jumpto", ['route'=>'novel', 'novel_id'=>$novel['id'], 'customer_id'=>$plat_wechat['customer_id'], 'dtype'=>2, 'uid'=>$uid], false);
            $str .= "ğŸ“– <a href='{$url}'>ã€Š{$novel['title']}ã€‹</a> ğŸ‘ˆ \r\n\r\n";
        }
        //$str .= "ä¸ºæ–¹ä¾¿ä¸‹æ¬¡é˜…è¯»ï¼Œè¯· <a href='{$host}/img/wechat.totop.png'>ç½®é¡¶ å…¬ä¼—å·</a>";
        $str .= $this->strEndKefuLink($host, $plat_wechat['customer_id']);
        return $str;
    }
    /**
     * æ–‡æœ¬æ¶ˆæ¯å¤„ç†å™¨
     * @param array $message
     */
    private function operateText($message) {
        // æ–‡æœ¬æ¶ˆæ¯å¤„ç†å™¨
        $appid = request()->input('appid');
        if ($message['Content'] == 'ç­¾åˆ°') {
            $msg = $this->signReply($message); // ç­¾åˆ°è¿”è¿˜
            if ($msg) {
                return $msg;
            }
        }
        $keyword_info = $this->wechatMsgReplies->KeyWordMsg($appid, $message['Content']);
        if (!$keyword_info) {
            // throw new \Exception('æ²¡æœ‰æŸ¥è¯¢åˆ°å¯¹åº”çš„å…³é”®å­—ï¼', 2000);
            // è®°å½•æœ€è¿‘æœ‰äº’åŠ¨çš„ç”¨æˆ·
            $wechat = $this->wechats->getWechatForAppid($appid); // è·å–å…¬ä¼—å·ä¿¡æ¯
            $wechat_config = $this->wechatConfigs->FindByCustomer2PlatWechat($wechat['customer_id'], $wechat['id']); // è·å–å…¬ä¼—å·é…ç½®

            $host = $this->domains->randOne(1, $wechat_config['customer_id']); // è·å–å†…æ¨å…¥å£åŸŸå
            // æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
            $user = $this->users->FindByOpenid($message['FromUserName'], ['name', 'id', 'first_account']);
            $uid = $user ? ($user['first_account'] > 0 ? $user['first_account'] : $user['id']) : -1;
            return $this->noUserPush($host, $wechat, 2, $uid);
        }

        $content = $keyword_info['reply_content'];
        if (IsJson($content)) {
            // æ˜¯å›å¤å›¾æ–‡æ¶ˆæ¯
            $content = json_decode($content, 1);
            if (strpos($content['img'], 'http') === false) {
                $content['img'] = $this->imgFontImgHost($content['img'], $keyword_info['customer_id']);
            }
            $item = [
                new NewsItem([
                    'title'         => $content['title'],
                    'description'   => $content['desc'],
                    'url'           => $content['url'],
                    'image'         => $content['img'],
                ]),
            ];
            $content = new News($item);
        }

        return $content;
    }
    // å›¾æ–‡æ¶ˆæ¯è¿½åŠ å›¾ç‰‡çš„åŸŸå
    private function imgFontImgHost($img, $customer_id) {
        $host = $this->domains->randOne(2, $customer_id); // è·å–å±•ç¤ºåŸŸå
        return $host . $img;
    }
    /**
     * å›¾ç‰‡æ¶ˆæ¯å¤„ç†å™¨
     * @param array $message
     */
    private function operateImage($message) {
        // æ–‡æœ¬æ¶ˆæ¯å¤„ç†å™¨
    }
    /**
     * é»˜è®¤æ¶ˆæ¯å¤„ç†
     * @param array $message
     */
    private function operateDefault($message) {
        // äº‹ä»¶é»˜è®¤å¤„ç†å™¨
    }
    /**
     * æœåŠ¡å™¨é…ç½®éªŒè¯ç­¾å
     */
    private function checkSignature()
    {
        $signature = $_GET["signature"];
        $timestamp = $_GET["timestamp"];
        $nonce = $_GET["nonce"];
        $appid = $_GET["appid"];

        $wechat = $this->wechats->findBy('appid', $appid, ['id', 'appid', 'service_token']);//->first()->value('appid');
        if (!$wechat) {
            return false;
        }
        $token = $wechat['service_token'];

        $tmpArr = array($token, $timestamp, $nonce);
        sort($tmpArr, SORT_STRING);
        $tmpStr = implode( $tmpArr );
        $tmpStr = sha1( $tmpStr );

        if( $tmpStr == $signature ){
            return true;
        }else{
            return false;
        }
    }
}
