<?php

namespace App\Logics\Services\src;

use App\Logics\Repositories\src\CommonSetRepository;
use App\Logics\Repositories\src\CustomerRepository;
use App\Logics\Repositories\src\DomainRepository;
use App\Logics\Repositories\src\ExtendLinkRepository;
use App\Logics\Repositories\src\PlatformWechatRepository;
use App\Logics\Repositories\src\UserRepository;
use App\Logics\Repositories\src\WechatConfigRepository;
use App\Logics\Services\Service;
use App\Logics\Traits\WechatTrait;

class UserService extends Service {
    use WechatTrait;

    protected $users;
    protected $domains;
    protected $commonSets;
    protected $platformWechats;
    protected $extendLinks;
    protected $wechatConfigs;
    protected $customers;

	public function Repositories() {
		return [
		    'platformWechats'   => PlatformWechatRepository::class,
            'commonSets'    => CommonSetRepository::class,
            'domains'       => DomainRepository::class,
            'users'         => UserRepository::class,
            'extendLinks'   => ExtendLinkRepository::class,
            'wechatConfigs' => WechatConfigRepository::class,
            'customers'     => CustomerRepository::class,
		];
	}
    /**
     * H5 å¾®ä¿¡æˆæƒç™»å½•
     */
    public function WechatLogin() {
        $sess = $this->loginGetSession(true);
        if ($sess['id']) {
            return $this->Logined($sess);
        }
        if (!isset($_GET['code']) || !$_GET['code']) {
            // æ²¡æœ‰æˆæƒ code è·³è½¬è·å–æˆæƒcode
            $customer_id = request()->input('customer_id');
            if (!$customer_id) {
                throw new \Exception('æœªå®šä¹‰å¹³å°ä¿¡æ¯', 2000);
            }

            $state = [
                'c'  => $customer_id,
                'p'  => urlencode(request()->input('backurl')),
                'el' => request()->input('el'),
                'od' => request()->input('otherdo'),
            ];
            return $this->ToAuthCode($customer_id, $state);
        } else {
            $state = $this->stateInfo(); // è·å–stateä¿¡æ¯
            if ($this->domains->TypeDomain(4, $state['c'])) {
                // èœå•åŸŸåï¼›è·³è½¬ä¸»é¡µå±•ç¤ºåŸŸå
                if ($host = $this->domains->TypeDomain(2, $state['c'])) {
                    // ä¸æ˜¯è½åœ°åŸŸåå°±è·³è½¬è½åœ°åŸŸåå†æ‰§è¡Œè·å–ç”¨æˆ·ä¿¡æ¯
                    return redirect($host . route('h5wechat.login', request()->input(), false));
                }
            } else{
                $host = $this->domains->TypeDomain(5, $state['c']);
                // ä¸æ˜¯è½åœ°åŸŸåå°±è·³è½¬å¤–æ¨å±•ç¤ºè½åœ°åŸŸåå†æ‰§è¡Œè·å–ç”¨æˆ·ä¿¡æ¯
                return redirect($host . route('h5wechat.login', request()->input(), false));
            }
            // é€šè¿‡æˆæƒ code è·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯
            $wechat_userinfo = $this->AuthToken2Openid();

            return $this->DoLogin('h5wechat', $wechat_userinfo);
        }

    }

    /**
     * æ‰§è¡Œç™»å½•
     * @param string $type
     * @param array $data
     */
    private function DoLogin($type, $data) {
        switch ($type) {
            case 'h5wechat':
                $user = $this->users->findBy('unionid', $data['unionid'], $this->users->model->fields);
                if (!$user) {
                    $user = $this->register('h5wechat', $data);
                }
        }

        $state = $this->stateInfo(); // è·å–stateä¿¡æ¯
        if ($user['subscribe'] && $host = $this->domains->TypeDomain(2, $state['c'])) {
            $now = time();
            $pass = encrypt(json_encode(['id'=>$user['id'], 'passwd'=>md5($user['id'] . 'zmr' . $now), 'time'=>$now]));
            return redirect($host . route('redirectLogin', ['pass'=>$pass, 'state'=>request()->input('state')], false));
        }

        $this->loginSaveToSession($user);
        return $this->Logined($user);
    }

    /**
     * H5 å¾®ä¿¡æˆæƒç™»å½•åŸŸåä¸å¯¹çš„è·³è½¬ç™»å½•
     * @param string $type
     * @param array $data
     */
    public function RedirectLogin() {
        $pass = request()->input('pass');
        $pass = decrypt($pass);
        $data = json_decode($pass, 1);
        if ($data['passwd'] != md5($data['id'] . 'zmr' . $data['time'])) {
            return $this->result([], 2000, 'æ•°æ®å¼‚å¸¸');
        }
        if ($data['time'] + 60 < time()) {
            return $this->result([], 2000, 'ç™»å½•å¼‚å¸¸');
        }
        $user = $this->users->UserCacheInfo($data['id']);

        $this->loginSaveToSession($user);
        return $this->Logined($user);
    }
    /**
     * æ‰§è¡Œæ³¨å†Œ
     * @param string $type H5å¾®ä¿¡ç™»å½• h5wechat
     * @param array $data
     */
    private function register($type, $data) {
        switch ($type) {
            case 'h5wechat':
                $state = $this->stateInfo(); // è·å–stateä¿¡æ¯

                $wechat = $this->platformWechats->getWechatForCustomer($state['c']); //è·å–å…¬ä¼—å¹³å°ä¿¡æ¯
                $data = [
                    'name'      => $data['nickname'],
                    'img'       => $data['headimgurl'],
                    'sex'       => $data['sex'],
                    'subscribe' => isset($data['subscribe']) ? $data['subscribe'] : 0,
                    'openid'    => $data['openid'],
                    'unionid'   => $data['unionid'],
                    'password'  => md5('123456' . 'zmrpasswd'),
                    'invite_code'   => 0,
                    'customer_id'   => $state['c'],
                    'platform_wechat_id'    => $wechat['id'],
                    'extend_link_id'        => (isset($state['el']) && is_numeric($state['el'])) ? $state['el'] : 0,
                ];
                break;
        }

        $user = $this->users->create($data);

        if ($user['extend_link_id']) {
            // æ¨å¹¿é“¾æ¥å¢åŠ ç”¨æˆ·
            $this->extendLinks->UpdateInfo($user['extend_link_id'], ['user'=>1]);
        }
        return $user;
    }
    /**
     * ç™»å½•æˆåŠŸï¼›è·³è½¬é¦–é¡µ
     */
    private function Logined($user) {
        $state = $this->stateInfo();
        if (isset($state['p']) && $state['p']) {
            return redirect(urldecode($state['p']));
        }

        if (isset($state['el']) && $state['el']) {
            return redirect(route('novel.extendpage', ['extend_link_id'=>$state['el'], 'customer_id'=>$state['c']]));
        }

        if (request()->input('od') == 'secondpush') {
            $this->pushSecondMsg($user, $state['n'], $state['c']); // æ‰§è¡Œæ–°ç”¨æˆ·äºŒæ¬¡æ¨é€
        }

        return redirect(route('novel.toindex', ['cid'=>$user['customer_id'], 'otherdo'=>$state['od']]));
    }

    /**
     * è·å–ç”¨æˆ·ä¿¡æ¯
     */
    public function UserInfo() {
        $info = $this->loginGetSession(true);
        $uncolumn = ['openid', 'unionid', 'password', 'remember_token', 'customer_id', 'platform_wechat_id'];
        foreach ($uncolumn as $v) {
            unset($info[$v]);
        }

        return $this->result($info);
    }

    /**
     * æ¨é€äºŒæ¬¡æ¨¡æ¿æ¶ˆæ¯
     */
    private function pushSecondMsg($sess, $novel_id, $customer_id) {
        $wechatConf = $this->wechatConfigs->findByMap([
            ['customer_id', $customer_id],
            ['platform_wechat_id', $sess['platform_wechat_id']],
        ], ['subscribe_msg_next']);
        if (!$wechatConf) {
            return false;
        }
        $config = json_decode($wechatConf['subscribe_msg_next'], 1);

<<<<<<< .mine
}
=======
        // $url = '/front/#/detail/novel-258.html';
        //$url = $host . route("novel.tosection", ['novel_id'=>$novel_id, 'section'=>$section, 'customer_id'=>$plat_wechat['customer_id'], 'do'=>'secondpush'], false);

        $host = $this->domains->randOne(1, $customer_id);
        $str = "æ­å–œæ‚¨ï¼›è·å¾—ä»¥ä¸‹å›¾ä¹¦ä¼˜å…ˆé˜…è¯»æƒï¼\r\n\r\n
                ğŸ‘‰<a href='" . $host . route("novel.tosection", ['novel_id'=>$novel_id, 'section'=>0, 'customer_id'=>$customer_id], false) ."'>ç‚¹æˆ‘ç»§ç»­ä¸Šæ¬¡é˜…è¯»</a>\r\n\r\n
                ã€ä»Šæ—¥æ¨èã€‘\r\n\r\n";
        // æŸ¥è¯¢ç½‘ç«™æ¨¡æ¿
        $customer = $this->customers->find($customer_id, ['web_tpl']);
        $host = $host . '/'. $customer['web_tpl'] . '/#/detail/novel-';//258.html';
        $str .="ğŸ‘‰<a href='{$host}{$config['nid'][0]}.html'>{$config['title'][0]}</a>\r\n\r\n
                ğŸ‘‰<a href='{$host}{$config['nid'][1]}.html'>{$config['title'][1]}</a>\r\n\r\n
                ğŸ‘‰<a href='{$host}{$config['nid'][2]}.html'>{$config['title'][2]}</a>\r\n\r\n
                ğŸ‘‰{$config['bottom'][0]}ï¼Œ<a href='{$config['bottom'][1]}'>{$config['bottom'][2]}</a>";


        $content = [
            'touser'    => $sess['openid'],
            'msgtype'   => 'text',
            'text'      => [
                'content'   => $str,
            ],
        ];
        try {
            $this->SendCustomMsg($customer_id, $content, true);
            return true;
        } catch (\Exception $e) {
            return false;
        }
    }

}>>>>>>> .r650
