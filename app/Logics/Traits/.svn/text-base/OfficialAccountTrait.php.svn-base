<?php
namespace App\Logics\Traits;

use App\Logics\Repositories\src\CommonSetRepository;
use App\Logics\Repositories\src\UserRepository;
use App\Logics\Repositories\src\WechatRepository;

trait OfficialAccountTrait
{
    protected $wechat;

    protected $appId;
    protected $appSecret;
    protected $redirectUri;

    /**
     * åˆå§‹åŒ–ç±»å±æ€§
     * @param int $customer_id
     */
    private function initOfficialAccountTrait($customer_id, $wechat_id = 0, $wechat = []) {
        if ($this->wechat && $this->wechat['token_out'] > time()) {
            return false; // å…¬ä¼—å·å·²ç»å®ä¾‹åŒ–å¹¶ä¸”tokenæœªè¿‡æœŸï¼›å°±ç›´æ¥ä½¿ç”¨
        }

        if ($wechat_id) {
            $wechat = $this->getWechatsInOfficialAccountTrait()->getWechatForId($wechat_id); //è·å–å…¬ä¼—å¹³å°ä¿¡æ¯
        } else {
            $wechat = $this->getWechatsInOfficialAccountTrait()->getWechatForCustomer($customer_id); //è·å–å…¬ä¼—å¹³å°ä¿¡æ¯
        }

        if(!$wechat || !$wechat['status']){
            throw new \Exception('è¯¥çŠ¶æ€å·²ç»å…³é—­', 20002);
        }

        $this->appId = $wechat['appid'];
        $this->appSecret = $wechat['appsecret'];

        if (!$wechat['token'] || $wechat['token_out'] < time()) {
            $wechat = $this->updateWechatAccessToken($wechat);
        }

        //$auth_domain = $this->getCommonSetsInOfficialAccountTrait()->values('wechat', 'auth_domain');
        $auth_domain = $wechat['redirect_uri'];
        $this->redirectUri = urlencode($auth_domain . route('h5wechat.redirect', ['wechat_id'=>$wechat['id']], false));


        $this->wechat = $wechat;
    }

    /**
     * è·³è½¬è·å–æˆæƒcode
     * @param int $customer_id
     * @param array $state
     * @param string $scope  snsapi_baseä¸ºscopeçš„ç½‘é¡µæˆæƒï¼Œå°±é™é»˜æˆæƒçš„ï¼Œç”¨æˆ·æ— æ„ŸçŸ¥ï¼› snsapi_userinfo è·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯
     */
    public function ToAuthCode($customer_id, $state = ['id'=>0], $scope = ''){
        $this->initOfficialAccountTrait($customer_id);

        $scope = $scope === 'tip' ? 'snsapi_userinfo' : 'snsapi_base';

        if(!$this->appId || !$this->appSecret || !$this->redirectUri){
            throw new \Exception('ç¼ºå°‘é…ç½®ä¿¡æ¯', 20001);
        }

        $state = $this->stateInfo($state);

        // å…¬ä¼—å·æ¨¡å¼è·å–æˆæƒç 
        $url = "https://open.weixin.qq.com/connect/oauth2/authorize?appid={$this->appId}&redirect_uri={$this->redirectUri}&response_type=code&scope={$scope}&state={$state}#wechat_redirect";

        return redirect($url);
    }
    /**
     * è·³è½¬è·å–æˆæƒcode
     * @param int $customer_id
     * @param array $state
     * @param string $scope  snsapi_baseä¸ºscopeçš„ç½‘é¡µæˆæƒï¼Œå°±é™é»˜æˆæƒçš„ï¼Œç”¨æˆ·æ— æ„ŸçŸ¥ï¼› snsapi_userinfo è·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯
     */
    public function ToPayWechatAuthCode($wechat, $state = ['id'=>0]){
        if(!$wechat['appid'] || !$wechat['appsecret'] || !$wechat['redirect_uri']){
            throw new \Exception('ç¼ºå°‘é…ç½®ä¿¡æ¯', 20001);
        }

        $state = $this->stateInfo($state);

        //$auth_domain = $this->getCommonSetsInOfficialAccountTrait()->values('wechat', 'auth_domain');
        $auth_domain = $wechat['redirect_uri'];
        $redirectUri = urlencode($auth_domain . route('h5wechat.login', [], false));
        // å…¬ä¼—å·æ¨¡å¼è·å–æˆæƒç 
        $url = "https://open.weixin.qq.com/connect/oauth2/authorize?appid={$wechat['appid']}&redirect_uri={$redirectUri}&response_type=code&scope=snsapi_base&state={$state}#wechat_redirect";

        return redirect($url);
    }

    /**
     * è·å–æˆæƒtokenå’Œç”¨æˆ·openid
     * ç”¨äºæ¢åŒºç”¨æˆ·è¯¦ç»†ä¿¡æ¯
     * @param int $type    novel-wechat å°è¯´ç™»å½•ï¼›pay-wechat æ”¯ä»˜ç™»å½•
     * @param array $wechat å…¬ä¼—å·ä¿¡æ¯
     */
    public function GetAuthToken2Openid($type = 'novel-wechat', $wechat = []){
        $code  = request()->input('code');
        if (!$code) {
            throw new \Exception('æœªè·å–åˆ° code æˆ– state ä¿¡æ¯', 2000);
        }

        $state = $this->stateInfo(); // è·å–stateä¿¡æ¯

        if ($type === 'novel-wechat') {
            if (request()->wechat_id > 0) {
                if (!$this->wechat ||
                    !isset($this->wechat['id']) ||
                    $this->wechat['id'] != request()->wechat_id) {
                    $this->wechat = null;
                }
                $this->initOfficialAccountTrait(0, request()->wechat_id);
            } else {
                $this->initOfficialAccountTrait($state['c']);
            }
        } else {
            $this->wechat = $wechat;
        }

        // å…¬ä¼—å·æ¨¡å¼è·å– ç½‘é¡µæˆæƒaccess_token å’Œ openid
        $url = "https://api.weixin.qq.com/sns/oauth2/access_token?appid={$this->wechat['appid']}&secret={$this->wechat['appsecret']}&code={$code}&grant_type=authorization_code";

        // è¿™ä»–å¦ˆçš„ä¸çŸ¥é“æ€ä¹ˆåœ°å°±å¶å°”æç¤º access_token å¼‚å¸¸
        $i = 0;
        $err_str = '';
        while ($i < 3) {
            $i++;
            $rel = @file_get_contents($url);
            $rel = json_decode($rel, 1);
            if (isset($rel['access_token'])) {
                break;
            }

            if (isset($rel['errmsg'])) {
                $err_str .= $i . ' = ' . $this->wechat['appid'] . '___' . $rel['errmsg'] . '___' . $code . '______';
            }
        }
        if (isset($rel['errcode']) && $rel['errcode'] > 100) {
            $err_str .= '__we_id='.request()->wechat_id.'__we_na='.$this->wechat['name'].'__'.$this->wechat['appid'];
            if ($wechat) {
                // è¡¨ç¤ºæ˜¯æ”¯ä»˜å·æˆæƒ
                $err_str .= '__pppy';
            }
            throw new \Exception($err_str, $rel['errcode']);
        }

        return [$rel['openid'], $rel['access_token']];
    }
    /**
     * è·å–å¾®ä¿¡é‚£è¾¹çš„ç”¨æˆ·è¯¦ç»†ä¿¡æ¯
     * @param string $access_token
     * @param string $openid
     */
    public function GetWechatUserDetail($customer_id, $access_token, $openid) {
        if ($customer_id) {
            $this->initOfficialAccountTrait($customer_id);
        }

        // é‡‡ç”¨ç½‘é¡µæˆæƒ token è·å–ç”¨æˆ·çš„ä¿¡æ¯ï¼›è·å–ä¸åˆ° æ˜¯å¦å…³æ³¨
        $wechat_user =  $this->getWechatUserInfo($access_token, $openid);

        // é‡‡ç”¨ token è·å–ç”¨æˆ·çš„è¯¦ç»†ä¿¡æ¯ å¯ä»¥è·å–æ˜¯å¦å…³æ³¨
        try {
            $temp =  $this->getWechatUserInfo($this->wechat['token'], $openid, true);
            return array_merge($wechat_user, $temp);
        } catch (\Exception $e) {
            $wechat_user['subscribe'] = 0;
            return $wechat_user;
        }
    }

    /**
     * è·å–ç”¨æˆ·å¾®ä¿¡è¯¦ç»†ä¿¡æ¯
     * @param string $access_token
     * @param string $openid
     * @param bool $detail æ˜¯å¦è·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯
     */
    private function getWechatUserInfo($access_token, $openid, $detail = false){
        //è·å–å¾®ä¿¡ä¿¡æ¯
        $url = "https://api.weixin.qq.com/sns/userinfo?access_token={$access_token}&openid={$openid}&lang=zh_CN";
        if ($detail) {
            $url = "https://api.weixin.qq.com/cgi-bin/user/info?access_token={$access_token}&openid={$openid}&lang=zh_CN";
        }
        $rel = @file_get_contents($url);
        $rel = json_decode($rel, 1);
        if(isset($rel['errcode']) && $rel['errcode'] > 100){
            throw new \Exception('ä¿¡æ¯è·å–å¤±è´¥ï¼' . $rel['errmsg'], 2003);
        }
        if(!$rel['openid']){
            //å½“è·å–å¤±è´¥æ—¶
            throw new \Exception('invalid openid', 40003);
        }
        return $rel;
    }

    /**
     * æ›´æ–° å…¬ä¼—å· access_token
     * @param array $wechat å…¬ä¼—å·æ•°æ®
     * @param array $platform å¼€æ”¾å¹³å°æ•°æ®
     * @return array $wechat
     */
    private function updateWechatAccessToken($wechat) {
        $passwd = md5($wechat['appid'] . 'zmr-37892jkfds' . $wechat['appsecret']);
        $url = "http://47.75.174.176/wechat_token.php?func=getAccessToken&appid={$wechat['appid']}&app_secret={$wechat['appsecret']}&passwd={$passwd}";
        $rel = @file_get_contents($url);
        $rel = json_decode($rel, 1);

        /*
        $url = "https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid={$wechat['appid']}&secret={$wechat['appsecret']}";
        $rel = @file_get_contents($url);
        $rel = json_decode($rel, 1);
        */

        if (!isset($rel['access_token'])) {
            throw new \Exception('å…¬ä¼—å· access_token è·å–å¤±è´¥ï¼' . $rel['errmsg'], $rel['errcode']);
        }
        $data = [
            'token'         => $rel['access_token'],
            'token_out'     => time() + $rel['expires_in'] - 600,
        ];
        $wechat['token_out'] = $data['token_out'];
        $wechat['token']     = $data['token'];
        // æ›´æ–°ä¿¡æ¯åˆ°æ•°æ®åº“
        $this->getWechatsInOfficialAccountTrait()->update($data, $wechat['id']);
        $this->getWechatsInOfficialAccountTrait()->ClearCache($wechat['customer_id'], $wechat['id']);
        return $wechat;
    }


    /**
     * è·å–stateä¿¡æ¯
     * @param array $state
     */
    protected function stateInfo($state=[]) {
        if ($state && is_array($state)) {
            $state = Array2String($state, true);
        } else {
            if (!$state) {
                $state = request()->input('state');
            }
            $state = Array2String($state);
        }

        return $state;
    }
    /**
     * ç”Ÿæˆå¸¦å‚æ•°äºŒç»´ç 
     * @param int $customer_id å®¢æˆ·ID
     * @param array $scene_str_arr åœºæ™¯å‚æ•°å†…å®¹
     */
    public function ProductParamsQRCode($customer_id, array $scene_str_arr, $action_name = 'QR_STR_SCENE')
    {
        $this->initOfficialAccountTrait($customer_id);
        $url = 'https://api.weixin.qq.com/cgi-bin/qrcode/create?access_token='. $this->wechat['token'];
        $params = [
            // 'expire_seconds' => 3600,
            'action_name'    => $action_name,
            'action_info'    => [
                'scene'      => [
                    'scene_str' => Array2String($scene_str_arr),
                ]
            ]
        ];
        if (in_array($action_name, ['QR_SCENE', 'QR_STR_SCENE'])) {
            $params['expire_seconds'] = 3600;
        }
        $i = 0;
        while ($i < 3) {
            $rel = CallCurl($url, $params, true, 'json');
            $rel = json_decode($rel, 1);
            if (isset($rel['ticket']) && isset($rel['url'])) break;
            $i++;
            //usleep(500000); // å»¶è¿Ÿ500æ¯«ç§’å†è¯·æ±‚ç« èŠ‚å†…å®¹
        }
        if (!isset($rel['ticket']) || !isset($rel['url'])) {
            throw new \Exception('äºŒç»´ç åˆ›å»ºå¤±è´¥ï¼' . $rel['errmsg'], 2000);
        }
        $url = 'https://mp.weixin.qq.com/cgi-bin/showqrcode?ticket=' . $rel['ticket'];
        $rel = @file_get_contents($url);

        /*$rel = base64_encode($rel);
        $qrcode = 'data:image/png;base64,' . $rel;
        die("<img src='{$qrcode}'>");*/

        return $rel;
    }
    /**
     * é…ç½®å…¬ä¼—å·èœå•
     * @param int $customer_id å®¢æˆ·ID
     * @param array $menus èœå•åˆ—è¡¨
     */
    public function ProductWechatMenu($customer_id, array $menus)
    {
        $this->initOfficialAccountTrait($customer_id);
        $url = 'https://api.weixin.qq.com/cgi-bin/menu/create?access_token='. $this->wechat['token'];

        $rel = CallCurl($url, $menus, true, 'json', JSON_UNESCAPED_UNICODE);
        $rel = json_decode($rel, 1);
        if (isset($rel['errcode']) && $rel['errcode'] > 100) {
            throw new \Exception('èœå•é…ç½®å¤±è´¥ï¼' . $rel['errmsg'], 2000);
        }

        return $rel;
    }
    /**
     * é…ç½®å…¬ä¼—å·ä¸ªæ€§åŒ–èœå•
     * @param int $customer_id å®¢æˆ·ID
     * @param array $menus èœå•åˆ—è¡¨
     */
    public function ProductWechatConditionMenu($customer_id, array $menus)
    {
        $this->initOfficialAccountTrait($customer_id);
        $url = 'https://api.weixin.qq.com/cgi-bin/menu/addconditional?access_token='. $this->wechat['token'];

        $rel = CallCurl($url, $menus, true, 'json', JSON_UNESCAPED_UNICODE);
        $rel = json_decode($rel, 1);
        if (isset($rel['errcode']) && $rel['errcode'] > 100) {
            throw new \Exception('èœå•é…ç½®å¤±è´¥ï¼' . $rel['errmsg'], 2000);
        }

        return $rel;
    }
    /**
     * é…ç½®å…¬ä¼—å·æ ‡ç­¾ï¼Œè·å–æ ‡ç­¾ä¿¡æ¯
     * @param int $customer_id å®¢æˆ·ID
     * @param string $type æ“ä½œç±»å‹
     * @param array $tags æ“ä½œæ•°æ®
     */
    public function TagsManage($customer_id, $type, array $tags = [])
    {
        if (!in_array($type, ['create', 'get', 'update', 'delete'])) {
            throw new \Exception('æ“ä½œæ ‡ç­¾ç±»å‹å¼‚å¸¸ï¼', 2000);
        }
        $this->initOfficialAccountTrait($customer_id);

        $url = 'https://api.weixin.qq.com/cgi-bin/tags/'. $type .'?access_token='. $this->wechat['token'];

        if ($tags) {
            // åˆ›å»ºï¼Œç¼–è¾‘ï¼Œåˆ é™¤æ ‡ç­¾
            $rel = CallCurl($url, $tags, true, 'json', JSON_UNESCAPED_UNICODE);
        } else {
            // è·å–æ ‡ç­¾ä¿¡æ¯
            $rel = CallCurl($url);
        }
        $rel = json_decode($rel, 1);

        $menu_names = [
            'create' => 'åˆ›å»ºæ ‡ç­¾',
            'get'    => 'è·å–å…¬ä¼—å·å·²åˆ›å»ºçš„æ ‡ç­¾',
            'update' => 'ç¼–è¾‘æ ‡ç­¾',
            'delete' => 'åˆ é™¤æ ‡ç­¾',
        ];
        if (isset($rel['errcode']) && $rel['errcode'] > 100) {
            throw new \Exception($menu_names[$type] . 'å¤±è´¥ï¼' . $rel['errmsg'], 2000);
        }

        return $rel;
    }
    /**
     * ç®¡ç†ç”¨æˆ·æ ‡ç­¾
     * @param int $customer_id å®¢æˆ·ID
     * @param string $type æ“ä½œç±»å‹
     * @param array $data æ“ä½œæ•°æ®
     */
    public function UserTagManage($customer_id, $type, array $data = [])
    {
        $urls = [
            'batch-tag'     => 'https://api.weixin.qq.com/cgi-bin/tags/members/batchtagging?access_token=',
            'batch-un-tag'  => 'https://api.weixin.qq.com/cgi-bin/tags/members/batchuntagging?access_token=',
            'batch-tag-list'=> 'https://api.weixin.qq.com/cgi-bin/tags/getidlist?access_token=',
        ];
        if (!isset($urls[$type])) {
            throw new \Exception('æ“ä½œæ ‡ç­¾ç±»å‹å¼‚å¸¸ï¼', 2000);
        }
        $this->initOfficialAccountTrait($customer_id);

        $url = $urls[$type] . $this->wechat['token'];

        $rel = CallCurl($url, $data, true, 'json', JSON_UNESCAPED_UNICODE);
        $rel = json_decode($rel, 1);

        $menu_names = [
            'batch-tag'     => 'ä¸ºç”¨æˆ·æ‰“æ ‡ç­¾',
            'batch-un-tag'  => 'ä¸ºç”¨æˆ·å–æ¶ˆæ ‡ç­¾',
            'batch-tag-list'=> 'è·å–ç”¨æˆ·èº«ä¸Šçš„æ ‡ç­¾åˆ—è¡¨',
        ];
        if (isset($rel['errcode']) && $rel['errcode'] > 100) {
            throw new \Exception($menu_names[$type] . 'å¤±è´¥ï¼' . $rel['errmsg'], 2000);
        }

        return $rel;
    }
    /**
     * è·å–æ¨¡æ¿æ¶ˆæ¯çš„æ¨¡æ¿åˆ—è¡¨
     * @param int $customer_id å®¢æˆ·ID
     */
    public function GetAllPrivateTemplate($customer_id)
    {
        $this->initOfficialAccountTrait($customer_id);
        $url = 'https://api.weixin.qq.com/cgi-bin/template/get_all_private_template?access_token='. $this->wechat['token'];

        $rel = @file_get_contents($url);
        $rel = json_decode($rel, 1);
        if (isset($rel['errcode']) && $rel['errcode'] > 100) {
            throw new \Exception('è·å–æ¨¡æ¿æ¶ˆæ¯çš„æ¨¡æ¿åˆ—è¡¨å¤±è´¥ï¼' . $rel['errmsg'], 2000);
        }

        return $rel;
    }
    /**
     * è·å–ç”¨æˆ·åˆ—è¡¨
     * @param int $wechat_id å¾®ä¿¡ID
     * @param string $next_openid å¾®ä¿¡ä¸‹ä¸€é¡µç¬¬ä¸€ä¸ªopenID
     */
    public function GetUserList($customer_id, $next_openid = '') {
        $this->initOfficialAccountTrait($customer_id);
        $url = 'https://api.weixin.qq.com/cgi-bin/user/get?access_token='. $this->wechat['token'];// .'&next_openid='. $next_openid;
        if ($next_openid) {
            $url .= '&next_openid='. $next_openid;
        }

        $rel = @file_get_contents($url);
        $rel = json_decode($rel, 1);
        if (isset($rel['errcode']) && $rel['errcode'] > 100) {
            throw new \Exception('è·å–ç”¨æˆ·åˆ—è¡¨å¤±è´¥ï¼' . $rel['errmsg'], 2000);
        }

        return $rel;
    }

    /**
     * å‘é€æ¨¡æ¿æ¶ˆæ¯
     * @param int $customer_id å®¢æˆ·ID
     * @param array $content æ¨¡æ¿æ¶ˆæ¯å†…å®¹
     * @param bool $sock é‡‡ç”¨ fsockopen å½¢å¼å‘é€
     */
    public function SendTemplate($customer_id, $content, $sock = false)
    {
        $this->initOfficialAccountTrait($customer_id);
        $url = 'https://api.weixin.qq.com/cgi-bin/message/template/send?access_token='. $this->wechat['token'];

        if ($sock) {
            // socket å‘é€æ¨¡æ¿æ¶ˆæ¯
            // return $this->sockPushTemplate($this->wechat['token'], $content);
            return SockPushTemplate($url, $content);
        }
        $rel = CallCurl($url, $content, 'true', 'json', JSON_UNESCAPED_UNICODE);
        $rel = json_decode($rel, 1);
        if (isset($rel['errcode']) && $rel['errcode'] > 100) {
            throw new \Exception('å‘é€æ¨¡æ¿æ¶ˆæ¯å¤±è´¥ï¼' . $rel['errmsg'], 2000);
        }

        return $rel;
    }
    /**
     * æ¨é€å…¬ä¼—å·æ¨¡æ¿æ¶ˆæ¯
     * @param string $token
     * @param array $content æ¨¡æ¿æ¶ˆæ¯å†…å®¹
     */
    private function sockPushTemplates($token, $content) {
        $params = json_encode($content,JSON_UNESCAPED_UNICODE);
        $fp = fsockopen('api.weixin.qq.com', 80, $error, $errstr, 1);
        $http = "POST /cgi-bin/message/template/send?access_token={$token} HTTP/1.1\r\nHost: api.weixin.qq.com\r\nContent-type: application/x-www-form-urlencoded\r\nContent-Length: " . strlen($params) . "\r\nConnection:close\r\n\r\n$params\r\n\r\n";
        fwrite($fp, $http);
        fclose($fp);
    }
    /**
     * å‘é€å®¢æœæ¶ˆæ¯
     * @param int $customer_id å®¢æˆ·ID
     * @param array $content æ¶ˆæ¯å†…å®¹
     * @param bool $sock é‡‡ç”¨ fsockopen å½¢å¼å‘é€
     */
    public function SendCustomMsg($customer_id, $content, $sock = false)
    {
        $this->initOfficialAccountTrait($customer_id);
        $url = 'https://api.weixin.qq.com/cgi-bin/message/custom/send?access_token='. $this->wechat['token'];

        if ($sock) {
            // socket å‘é€æ¨¡æ¿æ¶ˆæ¯
            return SockPushTemplate($url, $content);
        }
        $rel = CallCurl($url, $content, 'true', 'json', JSON_UNESCAPED_UNICODE);
        $rel = json_decode($rel, 1);
        if (isset($rel['errcode']) && $rel['errcode'] > 100) {
            throw new \Exception('å‘é€å®¢æœæ¶ˆæ¯å¤±è´¥ï¼' . $rel['errmsg'], 2000);
        }

        return $rel;
    }



    /**
     * è¿”è¿˜ emoji è¡¨æƒ…å›¾ç‰‡
     * @param int $num
     */
    public function emojiArr($num = 1) {
        $emojies = [
            'â¤', 'ğŸ’', 'ğŸ’”', 'ğŸ’“', 'ğŸ’˜', 'ğŸ’–', 'ğŸ’—', 'ğŸ’', 'ğŸ’•', 'â£',
            'ğŸ’¤', 'ğŸ’¢', 'ğŸ‘£', 'ğŸ’‹', 'ğŸ’', 'ğŸ‘™', 'ğŸ‘“', 'ğŸ’Œ', 'ğŸ’¥', 'ğŸ¡',
            'ğŸ¹', 'ğŸ¾', 'ğŸ—', 'ğŸ¥¤', 'ğŸ«', 'ğŸˆ', 'ğŸ‰', 'ğŸ€', 'ğŸ„', 'ğŸ',
            'ğŸŠ', 'ğŸ¶', 'ğŸ¥‡', 'ğŸ’¯', 'ğŸŒ¹', 'ğŸŒ¸', 'ğŸŒº', 'ğŸŒ¼', 'ğŸŒ»', 'ğŸŒ·',
            'ğŸ’', 'â˜˜', 'ğŸ€', 'ğŸŒ´', 'ğŸŒ¾', 'ğŸ', 'ğŸ‚', 'ğŸƒ', 'ğŸŒ±', 'ğŸŒ¿',
            'ğŸŒ³', 'ğŸ”¥', 'âœ¨', 'ğŸŒŸ', 'ğŸ’«', 'â˜„', 'ğŸŒ™', 'âš¡', 'â­', 'â˜€',
            'ğŸŒ', 'ğŸŒ›', 'ğŸŒœ', 'ğŸ¾', 'ğŸ’', 'ğŸ‘„', 'ğŸ¤™', 'ğŸ’ƒ', 'ğŸ¤', 'ğŸ¤¯',

            'ğŸ˜˜', 'ğŸ˜‡',
        ];

        if ($num == 1) {
            return $emojies[mt_rand(0, 70)];
        } else {
            $i = 0;
            $rel = [];
            while ($i < $num) {
                $rel[] = $emojies[mt_rand(0, 70)];
                $i++;
            }
            return $rel;
        }
    }
    /**
     * è¿”å›è·³è½¬JSä»£ç 
     * @param string $hostUrl è·³è½¬åœ°å€
     */
    public function clickATag($hostUrl) {
        $now = time();
        $html = "<!DOCTYPE html><html><head><title>.....</title><meta name='viewport' content='width=device-width, initial-scale=1.0'>
                <style>#aa{$now}: {color: #E1E1E1;text-decoration: none;}
                .loader{$now}{position:fixed!important;top: 50%;left: 50%;margin:auto;margin-top: -3em;margin-left: -3em;font-size:10px;text-indent:-9999em;width:6em;height:6em;border-radius:50%;background:#959595;background:-moz-linear-gradient(left,#959595 10%,rgba(255,255,255,0) 42%);background:-webkit-linear-gradient(left,#959595 10%,rgba(255,255,255,0) 42%);background:-o-linear-gradient(left,#959595 10%,rgba(255,255,255,0) 42%);background:-ms-linear-gradient(left,#959595 10%,rgba(255,255,255,0) 42%);background:linear-gradient(to right,#959595 10%,rgba(255,255,255,0) 42%);position:relative;-webkit-animation:load3 1.4s infinite linear;animation:load3 1.4s infinite linear;-webkit-transform:translateZ(0);-ms-transform:translateZ(0);transform:translateZ(0)}
                .loader{$now}:before{width:50%;height:50%;background:#959595;border-radius:100% 0 0 0;position:absolute;top:0;left:0;content:''}
                .loader{$now}:after{background:#fff;width:75%;height:75%;border-radius:50%;content:'';margin:auto;position:absolute;top:0;left:0;bottom:0;right:0}@-webkit-keyframes load3{0%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}100%{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}@keyframes load3{0%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}100%{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}</style>
                </head><body>";
        $html .= "<div class='loader{$now}'>  <a id='aa{$now}' href='{$hostUrl}'>ç™»å½•ä¸­......</a>  </div>";
        $html .= "<script> document.getElementById('aa{$now}').click(); </script></body></html>";
        //$html .= "<script> window.location.href = '{$hostUrl}'; </script>";
        // return redirect($hostUrl);
        return $html;
    }
    public function getWechatsInOfficialAccountTrait() {
        if (!isset($this->wechats) || !$this->wechats) {
            $this->wechats = new WechatRepository();
        }
        return $this->wechats;
    }
    public function getUsersInOfficialAccountTrait() {
        if (!isset($this->users) || !$this->users) {
            $this->users = new UserRepository();
        }
        return $this->users;
    }
    public function getCommonSetsInOfficialAccountTrait() {
        if (!isset($this->commonSets) || !$this->commonSets) {
            $this->commonSets = new CommonSetRepository();
        }
        return $this->commonSets;
    }
}
