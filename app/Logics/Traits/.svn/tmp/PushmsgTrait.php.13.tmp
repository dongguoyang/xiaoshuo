<?php
namespace App\Logics\Traits;

use App\Jobs\SendCustomerMsg;
use App\Logics\Repositories\src\CustomerRepository;
use App\Logics\Repositories\src\DomainRepository;
use App\Logics\Repositories\src\PlatformRepository;
use App\Logics\Repositories\src\PlatformWechatRepository;
use App\Logics\Repositories\src\SignLogRepository;
use App\Logics\Repositories\src\UserRepository;
use App\Logics\Repositories\src\WechatConfigRepository;
use App\Logics\Services\src\OperateService;
use Illuminate\Support\Carbon;
use Illuminate\Support\Facades\Cache;

trait PushmsgTrait
{
    /**
     * æ¨é€å…³æ³¨æ¨é€çš„äºŒæ¬¡æ¨¡æ¿æ¶ˆæ¯
     */
    protected function pushSecondMsg($sess, $novel_id, $customer_id) {
        if (!$sess['id']) {
            return false;
        }

        $key = config('app.name') . 'push_second_msg_' . $sess['id'];
        $last_time = Cache::get($key);
        if ($last_time && $last_time > (time() - 1800)) {
            return false; // 10å°æ—¶å†…æ¨é€è¿‡äº†ï¼Œå°±ä¸æ¨é€
        }
        Cache::add($key, time(), Carbon::now()->addMinutes(600));

        $wechatConf = $this->getWechatConfigsInPushmsgTrait()->findByMap([
            ['customer_id', $customer_id],
            ['platform_wechat_id', $sess['platform_wechat_id']],
        ], ['subscribe_msg_next']);
        if (!$wechatConf) {
            return false;
        }
        $config = json_decode($wechatConf['subscribe_msg_next'], 1);

        // $url = '/front/#/detail/novel-258.html';
        //$url = $host . route("novel.tosection", ['novel_id'=>$novel_id, 'section'=>$section, 'customer_id'=>$plat_wechat['customer_id'], 'do'=>'secondpush'], false);

        $host = $this->getDomainsInPushmsgTrait()->randOne(1, $customer_id);
        $str = "æ­å–œæ‚¨ï¼›è·å¾—ä»¥ä¸‹å›¾ä¹¦ä¼˜å…ˆé˜…è¯»æƒï¼\r\n\r\n";
        if ($novel_id) {
            $str .= "ğŸ‘‰<a href='" . $host . route("jumpto", ['route'=>'section', 'section_num'=>0, 'dtype'=>2, 'novel_id'=>$novel_id, 'section'=>0, 'customer_id'=>$customer_id], false) ."'>ç‚¹æˆ‘ç»§ç»­ä¸Šæ¬¡é˜…è¯»</a>\r\n\r\n
ã€ä»Šæ—¥æ¨èã€‘\r\n\r\n";
        }
        // æŸ¥è¯¢ç½‘ç«™æ¨¡æ¿
        //$customer = $this->getCustomersInPushmsgTrait()->find($customer_id, ['web_tpl']);
        //$host = $host . route('jumpto', ['route'=>'novel', 'novel_id'=>$config['nid'][0], 'cid'=>$customer_id], false) '/'. $customer['web_tpl'] . '/#/detail/novel-';//258.html';
        $str .="ğŸ‘‰<a href='{$host}" . route('jumpto', ['route'=>'novel', 'dtype'=>2, 'novel_id'=>$config['nid'][0], 'cid'=>$customer_id, 'customer_id'=>$customer_id], false) . "'>{$config['title'][0]}</a>\r\n\r\n
ğŸ‘‰<a href='{$host}" . route('jumpto', ['route'=>'novel', 'dtype'=>2, 'novel_id'=>$config['nid'][1], 'cid'=>$customer_id, 'customer_id'=>$customer_id], false) . "'>{$config['title'][1]}</a>\r\n\r\n
ğŸ‘‰<a href='{$host}" . route('jumpto', ['route'=>'novel', 'dtype'=>2, 'novel_id'=>$config['nid'][2], 'cid'=>$customer_id, 'customer_id'=>$customer_id], false) . "'>{$config['title'][2]}</a>\r\n\r\n
ğŸ‘‰{$config['bottom'][0]}ï¼Œ<a href='{$config['bottom'][1]}'>{$config['bottom'][2]}</a>";


        $content = [
            'touser'    => $sess['openid'],
            'msgtype'   => 'text',
            'text'      => [
                'content'   => $str,
            ],
        ];
        try {
            $this->SendCustomMsg($customer_id, $content, true);
            return true;
        } catch (\Exception $e) {
            return false;
        }
    }
    /**
     * ç­¾åˆ° å…³é”®å­—å­—æ®µæ‰§è¡Œç­¾åˆ°å¹¶å›å¤ç­¾åˆ°æˆåŠŸ
     */
    protected function signReply($message) {
        $sess = $this->getUsersInPushmsgTrait()->findBy('openid', $message['FromUserName'], $this->getUsersInPushmsgTrait()->model->fields);
        $info = $this->getSignLogsInPushmsgTrait()->LastSignInfo($sess['id']);
        if ($info['signed']) {
            return 'ä»Šå¤©æ‚¨å·²ç­¾åˆ°æˆåŠŸï¼';
        }
        try {
            $operateSer = new OperateService();
            $operateSer->InserSignData($info, $sess);
            // return 'æ‚¨å·²æˆåŠŸç­¾åˆ°ï¼Œè·å¾—'.$sign['last_coin'].'ä¹¦å¸ï¼è¯·æ˜å¤©ç»§ç»­ç­¾åˆ°ï¼';
            return null;
        } catch (\Exception $e) {
            return 'ç­¾åˆ°å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ï¼';
        }
    }
    /**
     * å……å€¼å¤±è´¥æé†’
     */
    protected function RechargeMsg($user) {
        $key = config('app.name') . 'recharge_msg_' . $user['id'];
        $last_time = Cache::get($key);
        if ($last_time && $last_time > (time() - 1800)) {
            return false; // åŠå°æ—¶å†…æ¨é€è¿‡äº†ï¼Œå°±ä¸æ¨é€
        }
        Cache::add($key, time(), Carbon::now()->addMinutes(30));

        $host = $this->getDomainsInPushmsgTrait()->randOne(2, $user['customer_id']);
        if ($user['recharge_money']) {
            // å……å€¼å¤±è´¥æé†’
            $content = [
                'touser'    => $user['openid'],
                'msgtype'   => 'news',
                'news'      => [
                    'articles'  =>  [
                        [
                            'title'         => '>>> å……å€¼å¤±è´¥äº†ğŸ’”ğŸ’”ğŸ’”',
                            'description'   => 'äº²ï¼Œæ‚¨åˆšåˆšæäº¤çš„å……å€¼è®¢å•å……å€¼å¤±è´¥äº†ï¼Œç‚¹æˆ‘é‡æ–°å……å€¼å§ï¼',
                            'url'           => $host . route('jumpto', ['route'=>'recharge', 'dtype'=>2, 'customer_id'=>$user['customer_id']], false),
                            'picurl'        => 'https://novelsys.oss-cn-shenzhen.aliyuncs.com/coupon/images/49c27ed5be905cb2a2ac050ead023ec.png',
                        ],
                    ],
                ],
            ];
            //$this->SendCustomMsg($user['customer_id'], $content, true);
            SendCustomerMsg::dispatch($user['customer_id'], $content)->delay(180);
        } else {
            // é¦–å……ä¼˜æƒ æé†’
            $content = [
                'touser'    => $user['openid'],
                'msgtype'   => 'news',
                'news'      => [
                    'articles'  =>  [
                        [
                            'title'         => '>>> é¦–å……ä¼˜æƒ æ´»åŠ¨ğŸ‰ğŸ‰ğŸ‰',
                            'description'   => 'äº²ï¼Œé¦–æ¬¡å……å€¼ä»…éœ€9.9å…ƒï¼Œè¿˜é€æ‚¨900ä¸ªä¹¦å¸ï¼Œç‚¹å‡»å‰å¾€ï¼',
                            'url'           => $host . route('jumpto', ['route'=>'first_recharge', 'dtype'=>2, 'customer_id'=>$user['customer_id']], false),
                            'picurl'        => 'https://novelsys.oss-cn-shenzhen.aliyuncs.com/coupon/images/f4abd987efd929090b69a0414c8f077.png',
                        ],
                    ],
                ],
            ];
            //$this->SendCustomMsg($user['customer_id'], $content, true);
            SendCustomerMsg::dispatch($user['customer_id'], $content)->delay(180);
        }
    }




    public function getSignLogsInPushmsgTrait() {
        if (!isset($this->signLogs) || !$this->signLogs) {
            $this->signLogs = new SignLogRepository();
        }
        return $this->signLogs;
    }
    public function getPlatformWechatsInPushmsgTrait() {
        if (!isset($this->platformWechats) || !$this->platformWechats) {
            $this->platformWechats = new PlatformWechatRepository();
        }
        return $this->platformWechats;
    }
    public function getPlatformsInPushmsgTrait() {
        if (!isset($this->platforms) || !$this->platforms) {
            $this->platforms = new PlatformRepository();
        }
        return $this->platforms;
    }
    public function getUsersInPushmsgTrait() {
        if (!isset($this->users) || !$this->users) {
            $this->users = new UserRepository();
        }
        return $this->users;
    }
    public function getWechatConfigsInPushmsgTrait() {
        if (!isset($this->wechatConfigs) || !$this->wechatConfigs) {
            $this->wechatConfigs = new WechatConfigRepository();
        }
        return $this->wechatConfigs;
    }
    public function getDomainsInPushmsgTrait() {
        if (!isset($this->domains) || !$this->domains) {
            $this->domains = new DomainRepository();
        }
        return $this->domains;
    }
    public function getCustomersInPushmsgTrait() {
        if (!isset($this->customers) || !$this->customers) {
            $this->customers = new CustomerRepository();
        }
        return $this->customers;
    }
}
